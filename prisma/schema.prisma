generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  login     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value String
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  unit        String   @default("szt.")
  priceNet    Float
  vatRate     Float    @default(23) // np. 23, 8, 0
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Invoice {
  id               String        @id @default(cuid())
  type             String        @default("sales") // "cost" = faktura kosztowa, "sales" = faktura sprzedaży
  number           String        @unique
  issueDate        DateTime
  saleDate         DateTime?
  sellerName       String
  sellerNip        String
  buyerName        String
  buyerNip         String
  netAmount        Float
  vatAmount        Float
  grossAmount      Float
  currency         String        @default("PLN")
  paymentDueDate   DateTime?     // termin płatności (przypomnienie e-mail w ten dzień)
  recurringCode    String?       // np. zus, pit5, vat7 – rozrachunek cykliczny
  ksefSentAt       DateTime?
  ksefId           String?
  ksefStatus       String?
  source           String        @default("manual") // manual | ksef | mail | recurring
  emailSubject     String?       // temat maila (dla source=mail)
  emailBody        String?       @db.Text // treść wiadomości
  emailFrom        String?       // nadawca
  emailReceivedAt  DateTime?     // data otrzymania
  emailMessageId   String?       // Message-ID do deduplikacji
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  payment          Payment?
  items            InvoiceItem[]
  emailAttachments InvoiceEmailAttachment[]
}

model RecurringSettlement {
  id         String   @id @default(cuid())
  code       String   @unique // zus, pit5, vat7
  name       String   // ZUS, PIT-5, VAT-7
  sellerName String   @default("") // np. "Zakład Ubezpieczeń Społecznych"
  sellerNip  String   @default("") // NIP wystawcy / odbiorcy (opcjonalnie)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model InvoiceEmailAttachment {
  id         String   @id @default(cuid())
  invoiceId  String
  invoice    Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  filename   String
  contentType String  @default("application/octet-stream")
  size       Int      @default(0)
  storedPath String   // ścieżka do pliku na dysku
  createdAt  DateTime @default(now())
}

model InvoiceItem {
  id           String   @id @default(cuid())
  invoiceId    String
  invoice      Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  productId    String?
  name         String
  quantity     Float    @default(1)
  unit         String   @default("szt.")
  unitPriceNet Float
  vatRate      Float    @default(23)
  amountNet    Float
  amountVat    Float
}

model Payment {
  id         String   @id @default(cuid())
  invoiceId  String   @unique
  invoice    Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  paidAt     DateTime
  createdAt  DateTime @default(now())
}

model Contractor {
  id         String   @id @default(cuid())
  name       String
  nip        String
  address    String?
  postalCode String?
  city       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}
