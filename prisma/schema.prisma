generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  login     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Setting {
  id    String @id @default(cuid())
  key   String @unique
  value String
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  unit        String   @default("szt.")
  priceNet    Float
  vatRate     Float    @default(23) // np. 23, 8, 0
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Invoice {
  id               String        @id @default(cuid())
  type             String        @default("sales") // "cost" = faktura kosztowa, "sales" = faktura sprzedaży
  number           String        @unique
  issueDate        DateTime
  saleDate         DateTime?
  sellerName       String
  sellerNip        String
  buyerName        String
  buyerNip         String
  netAmount        Float
  vatAmount        Float
  grossAmount      Float
  currency         String        @default("PLN")
  paymentDueDate   DateTime?     // termin płatności (przypomnienie e-mail w ten dzień)
  recurringCode    String?       // np. zus, pit5, vat7 – rozrachunek cykliczny
  ksefSentAt       DateTime?
  ksefId           String?
  ksefStatus       String?
  source           String        @default("manual") // manual | ksef | mail | recurring
  handedOverToAccountant Boolean @default(false) // przekazane księgowej (tylko dla rozrachunków nie z KSeF)
  emailSubject     String?       // temat maila (dla source=mail)
  emailBody        String?       @db.Text // treść wiadomości
  emailFrom        String?       // nadawca
  emailReceivedAt  DateTime?     // data otrzymania
  emailMessageId   String?       // Message-ID do deduplikacji
  vatDeductionPercent  Float?    // udział VAT do odliczenia (1.0 = 100%, 0.5 = 50%) – moduł korzyści podatkowych
  costDeductionPercent Float?    // udział kosztu do odliczenia (1.0 = 100%, 0.75 = 75%)
  expenseType         String    @default("standard") // "standard" | "car" – typ wydatku (faktury zakupu)
  carId               String?   // powiązany samochód gdy expenseType = "car"
  includedInCosts     Boolean   @default(false) // ujęta w kosztach – liczy korzyść; nieujęta – korzyść 0
  remarks             String?   @db.Text // uwagi – opis dokumentu (faktury zakupu, rozrachunki)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  payment          Payment?
  car               Car?         @relation(fields: [carId], references: [id], onDelete: SetNull)
  items            InvoiceItem[]
  emailAttachments InvoiceEmailAttachment[]
}

model Car {
  id                  String    @id @default(cuid())
  name                String    // np. "Skoda Octavia"
  value               Float     // wartość w PLN (do ustalenia progu limitu)
  limit100k           Float     @default(100000)  // limit odliczenia przy wartości do 100 tys. PLN
  limit150k           Float     @default(150000)  // limit przy 100–150 tys.
  limit200k           Float     @default(200000) // limit przy pow. 150 tys.
  vatDeductionPercent Float     @default(0.5)     // 0.5 = 50%, 1 = 100% VAT do odliczenia
  sortOrder           Int       @default(0)      // kolejność na liście
  createdAt           DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  invoices           Invoice[]
}

model RecurringSettlement {
  id         String   @id @default(cuid())
  code       String   @unique // zus, pit5, vat7
  name       String   // ZUS, PIT-5, VAT-7
  formName   String   @default("") // formularz: ok, VAT-7, PIT-5 (nazewnictwo: ZUS - ok, US - VAT-7, US - PIT-5)
  sellerName String   @default("") // np. "Zakład Ubezpieczeń Społecznych"
  sellerNip  String   @default("") // NIP wystawcy / odbiorcy (opcjonalnie)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model InvoiceEmailAttachment {
  id         String   @id @default(cuid())
  invoiceId  String
  invoice    Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  filename   String
  contentType String  @default("application/octet-stream")
  size       Int      @default(0)
  storedPath String   // ścieżka do pliku na dysku
  createdAt  DateTime @default(now())
}

model InvoiceItem {
  id           String   @id @default(cuid())
  invoiceId    String
  invoice      Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  productId    String?
  name         String
  quantity     Float    @default(1)
  unit         String   @default("szt.")
  unitPriceNet Float
  vatRate      Float    @default(23)
  amountNet    Float
  amountVat    Float
}

model Payment {
  id         String   @id @default(cuid())
  invoiceId  String   @unique
  invoice    Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  paidAt     DateTime
  createdAt  DateTime @default(now())
}

model Contractor {
  id         String   @id @default(cuid())
  name       String
  nip        String
  address    String?
  postalCode String?
  city       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

/// Message-ID maili, z których faktura została już pobrana i usunięta – nie pobierać ponownie.
model DeletedMailInvoiceMessageId {
  id             String   @id @default(cuid())
  emailMessageId String   @unique
  createdAt      DateTime @default(now())
}
